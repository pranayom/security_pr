"""Tests for the vulnerability scanner."""

from pathlib import Path

from src.models import Severity
from src.scanners.vulnerability_scanner import scan_file, scan_vulnerabilities


FIXTURES = Path(__file__).parent / "fixtures"


class TestScanFile:
    def test_finds_sql_injection(self):
        findings = scan_file(FIXTURES / "sample_vulnerable.py")
        sql_findings = [f for f in findings if f.category == "SQL Injection"]
        assert len(sql_findings) >= 2

    def test_finds_command_injection(self):
        findings = scan_file(FIXTURES / "sample_vulnerable.py")
        cmd_findings = [f for f in findings if f.category == "Command Injection"]
        assert len(cmd_findings) >= 3  # os.system, subprocess shell=True, eval

    def test_finds_hardcoded_secrets(self):
        findings = scan_file(FIXTURES / "sample_vulnerable.py")
        secret_findings = [f for f in findings if f.category == "Hardcoded Secrets"]
        assert len(secret_findings) >= 2

    def test_finds_insecure_deserialization(self):
        findings = scan_file(FIXTURES / "sample_vulnerable.py")
        deser_findings = [f for f in findings if f.category == "Insecure Deserialization"]
        assert len(deser_findings) >= 2  # pickle + yaml

    def test_finds_weak_crypto(self):
        findings = scan_file(FIXTURES / "sample_vulnerable.py")
        crypto_findings = [f for f in findings if f.category == "Weak Cryptography"]
        assert len(crypto_findings) >= 1

    def test_finds_ssl_verify_disabled(self):
        findings = scan_file(FIXTURES / "sample_vulnerable.py")
        ssl_findings = [f for f in findings if f.category == "SSL/TLS Issues"]
        assert len(ssl_findings) >= 1

    def test_finds_debug_mode(self):
        findings = scan_file(FIXTURES / "sample_vulnerable.py")
        debug_findings = [f for f in findings if f.category == "Debug Mode"]
        assert len(debug_findings) >= 1

    def test_clean_file_has_no_findings(self):
        findings = scan_file(FIXTURES / "sample_clean.py")
        assert len(findings) == 0

    def test_findings_have_correct_structure(self):
        findings = scan_file(FIXTURES / "sample_vulnerable.py")
        assert len(findings) > 0
        f = findings[0]
        assert f.file.endswith("sample_vulnerable.py")
        assert f.line > 0
        assert isinstance(f.severity, Severity)
        assert f.category
        assert f.pattern_name
        assert f.matched_text
        assert f.description


class TestScanVulnerabilities:
    def test_scan_single_file(self):
        result = scan_vulnerabilities(str(FIXTURES / "sample_vulnerable.py"))
        assert result.files_scanned == 1
        assert result.total_findings > 0
        assert len(result.findings) == result.total_findings

    def test_scan_directory(self):
        result = scan_vulnerabilities(str(FIXTURES))
        assert result.files_scanned >= 2  # vulnerable + clean

    def test_scan_nonexistent_target(self):
        result = scan_vulnerabilities("/nonexistent/path")
        assert result.files_scanned == 0
        assert len(result.errors) == 1

    def test_clean_file_zero_findings(self):
        result = scan_vulnerabilities(str(FIXTURES / "sample_clean.py"))
        assert result.total_findings == 0
